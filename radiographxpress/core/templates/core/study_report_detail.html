{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Estudio - Radiograph Xpress</title>
    <link rel="stylesheet" href="{% static 'core/report.css' %}">
    <style>
        /* Inline styles for the back button to ensure it works independently of report.css */
        .back-button-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            cursor: pointer;
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .back-button-container:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>

<body>

    <!-- Back Button -->
    <div class="back-button-container" onclick="window.history.back()">
        <img src="{% static 'core/assets/icons/return_icon.svg' %}" alt="Regresar" width="35" height="35">
    </div>

    <div class="report-container">

        <!-- 1. Top Visual Section -->
        <div class="study-visual-section" onclick="openPacsModal()">
            {% if study.pacs_url %}
            <iframe src="{{ study.pacs_url }}" frameborder="0" width="100%" height="100%"
                style="border: none; display: block;"></iframe>
            {% else %}
            <!-- Fallback placeholder if no image -->
            <img src="https://placehold.co/1130x396" alt="Imagen no disponible, por favor contacte al laboratorio."
                class="study-image">
            {% endif %}

            <div class="image-overlay">
                VISUALIZACIÓN PACS
            </div>
        </div>

        <!-- 2. Report Content -->
        <div class="study-report-content">

            <!-- Date (Top Right) -->
            <div class="report-date-top-right">
                {{ study.id_report.date|date:"d/m/Y" }}
            </div>

            <!-- Main Title (e.g., "Mastografía y ultrasonido...") -->
            <h1 class="report-title-main">
                {% if study.id_report.about %}
                {{ study.id_report.about }}
                {% else %}
                Estudio de Imagenología
                {% endif %}
            </h1>

            <!-- Patient Description -->
            <div class="report-section">
                <h3 class="section-title">Descripción del paciente</h3>
                <div class="section-content">
                    {{ study.id_report.patients_description }}
                </div>
            </div>

            <!-- Findings (Optional in mock, but usually required) -->
            {% if study.id_report.findings %}
            <div class="report-section">
                <!-- Mock doesn't explicitly label Hallazgos but implies content blocks. We'll use title for clarity or omit if strict to mock text blocks only. 
                     Let's keep it structured for real data but style it like the mock's text blocks. -->
                <h3 class="section-title">Hallazgos</h3>
                <div class="section-content">
                    {{ study.id_report.findings|linebreaksbr }}
                </div>
            </div>
            {% endif %}

            <!-- Conclusion -->
            <div class="report-section">
                <h3 class="section-title-large">Conclusión</h3>
                <div class="section-content">
                    {{ study.id_report.conclusions|default:"Sin conclusiones registradas."|linebreaksbr }}
                </div>
            </div>

            <!-- Recommendations -->
            <div class="report-section">
                <h3 class="section-title-large">Recomendaciones</h3>
                <div class="section-content">
                    {{ study.id_report.recommendations|default:"Sin recomendaciones."|linebreaksbr }}
                </div>
            </div>

            <!-- 3. Doctor Signature -->
            <div class="doctor-signature-section">
                <div class="signature-container">
                    <!-- Signature Image -->
                    <!-- Using a placeholder or a 'signature' field if it existed. 
                          Since we don't have a signature image field on profile, we'll try to use a generated one or placeholder. -->
                    <img src="https://placehold.co/213x189?text=Firma" class="signature-image" alt="Firma del Doctor">

                    <!-- Doctor Name -->
                    <div class="doctor-name-sign">
                        Dr. {{ study.id_report.doctor_in_charge.name }} {{ study.id_report.doctor_in_charge.last_name }}
                    </div>

                    <!-- Specialty/Cedula -->
                    <div class="doctor-specialty-sign">
                        {{ study.id_report.doctor_in_charge.specialty|default:"Radiología" }} <br>
                        Cédula: {{ study.id_report.doctor_in_charge.professional_id|default:"N/A" }}
                    </div>
                </div>
            </div>

        </div>
    </div>
    </div>

    <!-- PACS Modal Overlay -->
    <div class="pacs-modal-overlay" id="pacsModal" onclick="closePacsModal()">
        <div class="pacs-modal-content" id="pacsModalContent" onclick="event.stopPropagation()">
        </div>
    </div>

    <script>
        const pacsUrl = "{{ study.pacs_url|default:''|safe }}";

        function openPacsModal() {
            if (!pacsUrl) return;

            const modal = document.getElementById('pacsModal');
            const container = document.getElementById('pacsModalContent');

            // Inject iframe dynamically to prevent adding to browser history stack
            container.innerHTML = '<iframe src="' + pacsUrl + '" class="pacs-modal-iframe" allowfullscreen></iframe>';
            modal.style.display = 'flex';
        }

        function closePacsModal() {
            const modal = document.getElementById('pacsModal');
            const container = document.getElementById('pacsModalContent');

            modal.style.display = 'none';
            container.innerHTML = ''; // Destroy iframe to stop content and clean up
        }
    </script>
</body>

</html>